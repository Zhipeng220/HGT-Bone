# ============================================================
# DSA-HGN Bone Stream Configuration - Stabilized Version v3
# ============================================================
# 主要改进:
# 1. 降低初始学习率，延长warmup
# 2. 调整正则化损失权重
# 3. 使用温度退火 (初始0.5 -> 最终0.1)
# 4. 增加dropout防止过拟合
# ============================================================

work_dir: ./work_dir/SHREC/bone2_stable_v3

# ============================================================
# 基础训练参数
# ============================================================
phase: train
save_result: True
start_epoch: 0
num_epoch: 100                    # 增加训练轮数
use_gpu: True
device: [0]

# 日志和保存
log_interval: 100
save_interval: 1
eval_interval: 1
save_log: True
print_log: True
pavi_log: False

# ============================================================
# 数据加载器
# ============================================================
train_feeder: feeder.feeder_hgt.Feeder
test_feeder: feeder.feeder_hgt.Feeder
num_worker: 4

train_feeder_args:
  data_path: /Users/gzp/Desktop/exp/DATA/SHREC2017_data/train_data.npy
  label_path: /Users/gzp/Desktop/exp/DATA/SHREC2017_data/train_label.pkl
  split: train
  random_choose: True
  random_shift: True              # 时序增强
  random_rot: True                # 旋转增强
  random_move: False              # 可选: 平移增强
  repeat: 5                       # 数据重复
  normalization: False
  window_size: 180
  debug: False
  use_mmap: True
  # HGT特征提取器参数
  use_sg: True                    # Savitzky-Golay滤波
  sg_window: 9
  sg_order: 2
  use_angles: True                # 骨骼间夹角特征
  use_rotations: True             # 旋转轴特征

test_feeder_args:
  data_path: /Users/gzp/Desktop/exp/DATA/SHREC2017_data/val_data.npy
  label_path: /Users/gzp/Desktop/exp/DATA/SHREC2017_data/val_label.pkl
  split: test
  debug: False
  use_mmap: True
  normalization: False
  window_size: 180
  use_sg: True
  sg_window: 9
  sg_order: 2
  use_angles: True
  use_rotations: True

batch_size: 32
test_batch_size: 32
debug: False

# ============================================================
# 模型配置
# ============================================================
model: net.dsa_hgn.Model

model_args:
  in_channels: 8                  # HGT特征维度: 3(vec) + 1(len) + 1(angle) + 3(rot)
  base_channels: 64               # 基础通道数
  num_class: 14                   # SHREC 14类手势
  num_person: 1                   # 单手
  graph: graph.shrec_line.Graph   # 线图(骨骼流)
  graph_args:
    labeling_mode: spatial
  num_point: 21                   # 骨骼数量
  num_hyperedges: 12              # 动态超边数量
  k_neighbors: 4                  # KNN邻居数
  adaptive: True                  # 自适应邻接矩阵
  use_virtual_conn: True          # 使用超图虚拟连接
  num_stages: 10                  # TCN-GCN层数
  inflate_stages: [5, 8]          # 通道膨胀阶段
  down_stages: [5, 8]             # 时序下采样阶段
  data_bn_type: VC                # BatchNorm类型
  drop_out: 0.15                  # ✅ [改进] 从0.1增加到0.15
  temperature: 0.1                # ✅ [关键] 最终温度 (初始温度自动设为1.0，逐渐退火)

weights: null
ignore_weights: []
loss: null
loss_args: {}

# ============================================================
# 优化器配置
# ============================================================
optimizer: SGD
optimizer_args: {}

# ✅ [关键改进] 学习率配置
base_lr: 0.05                     # 从0.1降低到0.05
step: [40, 60, 80]                # 多阶段衰减
lr_decay_rate: 0.1                # 衰减率
nesterov: True
weight_decay: 0.001               # 从0.0005增加到0.001

# ✅ [关键改进] Warmup配置
warm_up_epoch: 15                 # 从10增加到15

# ============================================================
# 损失权重配置 (核心调优)
# ============================================================
stream: bone                      # 骨骼流

# ✅ [关键改进] 正则化损失权重调整
lambda_entropy: 0.01              # 目标熵损失权重 (从0.005增加)
lambda_ortho: 0.05                # 原型正交损失权重 (从0.1降低)
lambda_physical: 0.05             # 物理约束损失权重 (从0.1降低)

# 回归损失权重
lambda_reg: 0.1                   # 回归MSE损失
lambda_bone: 0.05                 # 骨骼方向一致性损失

# 不再使用的参数
lambda_sparsity: 0.0              # 已废弃

# ============================================================
# 训练稳定性配置
# ============================================================
grad_clip_norm: 1.0               # 梯度裁剪阈值

# 不使用的参数
mining_epoch: 1000000             # 禁用困难样本挖掘
topk: 1

# ============================================================
# 评估配置
# ============================================================
show_topk: [1, 5]